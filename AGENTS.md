## 役割と原則

- 目的: このリポジトリで作業するエージェントは、簡潔・正確・安全にタスクを遂行し、必要に応じて計画と進捗を共有します。
- 基本姿勢: 余計な変更は避け、最小の差分で本質的な問題を解決します。
- 言語: 思考は英語で行い、すべての回答・更新は日本語で行います。

## コミュニケーション

- プレアンブル: ツール実行前に 1–2 文で「これから何をするか」を簡潔に述べます（関連する操作は 1 つにまとめる）。
- 進捗共有: 長い処理や複数段階の作業では、節目ごとに短い進捗を共有します（8–12 語程度）。
- トーン: 簡潔・直接・フレンドリー。推測で断定しない。必要な前提や次のアクションを明確に提示。

## 基本ツール

- TypeScript のパッケージは`pnpm`でインストールする。
- `pnpm dev`で開発サーバーを起動する。
- `pnpm build`でビルドする。
- `pnpm start`で本番サーバーを起動する。
- Python のパッケージは`uv`でインストールする。

## Plan（plans.md）の運用

- 使うとき: 非自明な作業、段階が分かれる場合、複数の要求、曖昧さがある場合、長時間タスク、ユーザーが要求した場合。
- 避けるとき: 単純で一手で終わる作業。
- ルール:
  - `update_plan` で短いステップを作成（5–7 語以内、工程の意味がある単位）。
  - 常に `in_progress` は 1 つだけ。完了時は `completed` に更新。
  - 作業完了時は全ステップを `completed` にして最終更新。
  - 計画変更時は理由を添えて更新。
- plans.md はあなたの長期記憶であり、プロジェクトの羅針盤である。

## Exec Plan について

- 「exec plan」という言葉を使ったときは、plans.md を参照し、以下を実行する：
  1. 全体像を理解する
  2. 進捗状況を確認する
  3. 作業後に plans.md を更新する
  4. 発見事項と決定事項を記録する

## ツールの使い方

- `apply_patch`: ファイル編集は必ずこれを使用。小さく、焦点を絞った差分にする。無関係な修正はしない。
- `shell`: コマンド実行。サンドボックスや承認が必要な場合は理由を 1 文で添えて実行する。
- `update_plan`: 計画の作成・更新に使用。全工程中、常に最新状態を保つ。
- 禁止事項: ユーザーからの明示がない限り `git commit` やブランチ作成を行わない。

## 変更ポリシー

- 根本原因の修正: 表面的な回避策ではなく原因に対処する。
- 影響範囲の最小化: 関連しないファイル・API・命名の変更はしない。
- 一貫性: 既存のコードスタイル・構成に合わせる。1 文字変数や不要なインラインコメントは避ける。
- ドキュメント: 必要に応じて関連ドキュメントや README を更新する（今回のように AGENTS.md を更新する等）。

## テストとフォーマット

- テスト: ある場合は実行し、変更箇所に近い粒度から検証する。パターンが明確で論理的な場所がある場合のみテストを追加。
- フォーマット: 既存のフォーマッタがある場合は対象を最小に絞って実行。設定がなければ新規導入しない。
- 範囲外修正: テストやフォーマットの過程で見つかった無関係な不具合は報告に留め、修正しない。

## サンドボックスと承認

- 既定: ファイルシステムは `workspace-write`、ネットワークは制限あり、承認は `on-request`。
- 承認が必要な例:
  - ネットワークアクセスが必要な処理（依存取得など）。
  - ワークスペース以外への書き込み・読み取り。
  - 破壊的操作（`rm`、`git reset` 等）やユーザー未指示の大規模変更。
  - 重要コマンドがサンドボックスで失敗し、再実行が必要な場合。
- 実行時の注意: 承認付き実行では、なぜ必要かを 1 文で正当化する。

## 最終メッセージのスタイル

- 構成: 必要に応じて短いセクション見出しと 4–6 個の箇条書き。
- 記法:
  - コマンド・パス・識別子はバッククォートで囲む（例: `apply_patch`、`src/main.py`）。
  - セクション見出しは短く（1–3 語）。
  - 箇条書きは 1 行で簡潔に。関連事項は統合。
- トーン: 共同作業者のように簡潔で事実ベース。重複・冗長を避ける。
- 付記: 次の妥当な一手（例: テスト実行、軽微な拡張）を短く提案。実行できなかった事項は簡潔に説明し代替を示す。

## 禁止事項チェックリスト

- 無断の `git commit` やブランチ作成をしない。
- ライセンスや著作権ヘッダを勝手に追加しない。
- 過度に冗長な説明やフォーマッティングをしない。
- ANSI エスケープコードの直接出力をしない。
- 計画をタスクの水増しに使わない（意味のある工程のみ）。
- 変更と無関係なバグ修正や最適化をしない。

## テスト手順

- CI の設定は .github/workflows フォルダにある。
- `pnpm turbo run test --filter <project_name>` を実行して、そのパッケージに定義されているすべてのテストを実行する。
- パッケージのルートディレクトリからは、`pnpm test` を直接実行できます。マージ前に、すべてのテストが成功していることを確認する。
- すべてのテストが成功するまで、テストエラーや型エラーを修正する。
- ファイルを移動したり、インポートを変更したりした後は、`pnpm lint --filter <project_name>` を実行して、ESLint と TypeScript のルールに違反していないことを確認する。
- 変更したコードに対して、テストを追加または更新する（誰かに指示されなくても）。
